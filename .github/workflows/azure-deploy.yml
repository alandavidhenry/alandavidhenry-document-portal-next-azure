name: Deploy to Azure App Service

on:
  push:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build
      run: npm run build
      
    - name: Prepare deployment package
      run: |
        # Create deployment package
        mkdir -p deploy
        # Copy the standalone output (which includes server.js)
        cp -r .next/standalone/* deploy/
        # Create required directory structure
        mkdir -p deploy/.next/
        # Copy build ID and other required files
        cp -r .next/build-manifest.json deploy/.next/
        cp -r .next/prerender-manifest.json deploy/.next/
        cp -r .next/required-server-files.json deploy/.next/
        cp -r .next/routes-manifest.json deploy/.next/
        cp -r .next/build-id.txt deploy/.next/
        cp -r .next/server deploy/.next/
        # Copy static files to the correct location
        mkdir -p deploy/.next/static
        cp -r .next/static/* deploy/.next/static/
        # Copy public directory
        cp -r public deploy/
        # Create a skip build file
        touch deploy/.skipNodeModulesExtraction

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_APP_NAME }}
        package: deploy