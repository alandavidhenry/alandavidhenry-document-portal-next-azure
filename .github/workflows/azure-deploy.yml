name: Deploy to Azure App Service

on:
  push:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build
      run: npm run build
      
    - name: Prepare deployment package
      run: |
        # Create deployment package from standalone output
        mkdir -p deploy
        cp -r .next/standalone/* deploy/
        cp -r .next/static deploy/.next/
        cp -r public deploy/
        
        # Create a file to indicate this is a pre-built app (skip build)
        touch deploy/.skipNodeModulesExtraction
        
        # Optional: Add a deploy.txt file with timestamp
        echo "Deployed on $(date)" > deploy/deploy.txt

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_APP_NAME }}
        package: deploy